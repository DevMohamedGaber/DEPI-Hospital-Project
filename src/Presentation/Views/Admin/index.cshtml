@using Shared.DTO;
@model PatientViewModel;
    <div id="mySidebar" class="sidebar">
      <a href="javascript:void(0)" class="closebtn" onclick="closeNav()">×</a>
      <a href="#">About</a>
      <a href="#">Logout</a>
      <a href="#">Q&A</a>
      <a href="#">Support</a>
      <!-- Add more links as needed -->
    </div>

    <div id="main">
      <button class="openbtn" onclick="toggleNav()">☰</button>
      <div class="container">
        <!-- Hero Section -->
        <div class="hero-section">
          <h1>Welcome, admin</h1>
          <p>Your health is our priority</p>
        </div>

        <a href="/Admin/ViewStaff">Show Staff Members</a>

        <!-- Appointments Section -->
       
        <!-- Add Appointment Modal -->
  <div class="modal fade" id="addAppointmentModal" tabindex="-1" role="dialog" aria-labelledby="addAppointmentModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="addAppointmentModalLabel">Add New Appointment</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <EditForm method="POST" asp-action="AddNewPatient" Model="AppointmentViewModel"> 
            <div class="form-group">
              <label for="appointmentDateTime">Date and Time</label>
              <input type="datetime-local" class="form-control" id="appointmentDateTime">
            </div> 
            <div class="form-group">
              <label for="appointmentDateTime">Patient Name</label>
              <span><button type="button" class="btn btn-primary mb-2 ml-2" data-toggle="modal" data-target="#addPatientModal">Add+</button></span>
              <input type="text" class="form-control" id="waitTime">
            </div>
            <div class="form-group">
              <label for="appointmentDateTime">National ID</label>
              <input type="text" class="form-control" id="waitTime">
            </div>             
            <div class="form-group">
              <label for="waitTime">Wait Time</label>
              <input type="text" class="form-control" id="waitTime">
            </div>
            <div class="form-group">
              <label for="roomNumber">Room Number</label>
              <input type="text" class="form-control" id="roomNumber">
            </div>
            <div class="form-group">
              <label for="doctor">Doctor</label>
              <span><button type="button" class="btn btn-primary mb-2 ml-2" data-toggle="modal" data-target="#addDoctorModal">Add+</button></span>
              <select class="form-control" id="doctor">
                <option>Dr.Ali</option>
                <option>Dr.samir</option>
              </select>
            </div>
            
            <div class="form-group">
              <label for="department">Department</label>
              <select class="form-control" id="department">
                <option>Dermatology</option>
                <option>Cardiology</option>
              </select>
            </div>
            <div class="form-group">
              <label for="appointmentType">Type</label>
              <select class="form-control" id="appointmentType">
                <option>Medical Examination</option>
                <option>Follow-up</option>
              </select>
            </div>
          </EditForm>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary" data-dismiss="modal" asp-action="AddNewAppointment">Save</button>
        </div>
      </div>
    </div>
  </div>
  
        <h2 class="mt-5 toggle-btn">
            Appointments ▽
            <span> <button class="btn btn-primary m-3" data-toggle="modal" data-target="#addAppointmentModal">Add+</button></span>  
        </h2>
        
        
        <div class="content">

          <div class="table-responsive">
        
  <table class="table table-bordered" id="appointmentTable">
    <thead>
      <tr>
        <th>ID</th>
        <th>Patient name</th>
        <th>National ID</th>
        <th>Date and Time</th>
        <th>Wait Time</th>
        <th>Doctor</th>
        <th>Type</th>
      </tr>
      <tr>
        <!-- Search inputs will be added dynamically -->
      </tr>
    </thead>
    
    
    <tbody>
        @foreach(var appointment in ViewBag.Appointments)
        {
          <tr>
            <td>appointment.Id</td>
            <td><a href="#" data-toggle="modal" data-target="#PatientModal">appointment.Patient.firestName</a></td>
            <td>35464655454656</td>
            <td>10:00 AM</td>
            <td>15 mins</td>
            <td><a href="#" data-toggle="modal" data-target="#doctorModal">appointment.Doctor.firestName</a></td>
            <td>Medical Examination</td>
          </tr>
        }
    </tbody>
  </table>
  <!-- Pagination -->
  <nav aria-label="Page navigation example">
    <ul class="pagination justify-content-center" id="pagination">
      <!-- Pagination items will be generated dynamically -->
    </ul>
  </nav>

        </div>
      </div>

        <!-- System users Section -->

        <h2 class="mt-5 toggle-btn">System users ▽</h2>
        
        <div class="content">
          <span><button type="button" class="btn btn-primary mb-2 ml-2" data-toggle="modal" data-target="#addPatientModal">Add Patient +</button></span>
          <span><button type="button" class="btn btn-primary mb-2 ml-2" data-toggle="modal" data-target="#addDoctorModal">Add doctor +</button></span>
          <span><button type="button" class="btn btn-primary mb-2 ml-2" data-toggle="modal" data-target="#addNurseModal">Add Nurse +</button></span> 
          <div class="table-responsive">
          <table class="table table-bordered" id="systemUsersTable">
            <thead>
              <tr>
                <th>ID</th>
                <th>User name</th>
                <th>Role</th>
                <th>Notes</th>
                <th>data created</th>
                <th>Actions</th>
              </tr>
              <tr>
                <!-- Search inputs will be added dynamically -->
              </tr>
            </thead>
            <tbody>
                @foreach(var member in ViewBag.Staff)
                {
                    <tr>
                        <td>@member.Id</td>
                        <td>@member.firstName</td>
                        <td>Dr. Jones</td>
                        <td>No issues found</td>
                        <td>No issues found</td>
                        <td> <a href="#" data-toggle="modal" data-target="#doctorModal"
                            >Details/Edit</a
                        ></td>
                    </tr>
                }
              
             
              <!-- Add more rows as needed -->
            </tbody>
          </table>
          <nav aria-label="Page navigation example">
            <ul class="pagination justify-content-center" id="paginationUsers">
              <!-- Pagination items will be generated dynamically -->
            </ul>
          </nav>
        </div>
      </div>
    </div>

    <!-- Doctor Modal -->
    <div
      class="modal fade"
      id="doctorModal"
      tabindex="-1"
      role="dialog"
      aria-labelledby="doctorModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="doctorModalLabel">Doctor Details</h5>
            <button
              type="button"
              class="close"
              data-dismiss="modal"
              aria-label="Close"
            >
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <!-- Doctor details go here -->
            <p>Name: Dr. Smith</p>
            <p>Specialization: Cardiology</p>
            <p>Experience: 15 years</p>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-dismiss="modal"
            >
              Close
            </button>
          </div>
        </div>
      </div>
    </div>
 <!-- Patient Modal -->
 <div
 class="modal fade"
 id="PatientModal"
 tabindex="-1"
 role="dialog"
 aria-labelledby="PatientModalLabel"
 aria-hidden="true"
>
 <div class="modal-dialog" role="document">
   <div class="modal-content">
     <div class="modal-header">
       <h5 class="modal-title" id="PatientModalLabel">Patient Details</h5>
       <button
         type="button"
         class="close"
         data-dismiss="modal"
         aria-label="Close"
       >
         <span aria-hidden="true">&times;</span>
       </button>
     </div>
     <div class="modal-body">
       <!-- Patient details go here -->
       <p>Name: Smith</p>
       <p>gender: male</p>
       <p>address: 33 naser city</p>
     </div>
     <div class="modal-footer">
       <button
         type="button"
         class="btn btn-secondary"
         data-dismiss="modal"
       >
         Close
       </button>
     </div>
   </div>
 </div>
</div>
<!-- Nurse Modal -->
<div
class="modal fade"
id="NurseModal"
tabindex="-1"
role="dialog"
aria-labelledby="NurseModalLabel"
aria-hidden="true"
>
<div class="modal-dialog" role="document">
  <div class="modal-content">
    <div class="modal-header">
      <h5 class="modal-title" id="NurseModalLabel">Nurse Details</h5>
      <button
        type="button"
        class="close"
        data-dismiss="modal"
        aria-label="Close"
      >
        <span aria-hidden="true">&times;</span>
      </button>
    </div>
    <div class="modal-body">
      <!-- Nurse details go here -->
      <p>Name: Smith</p>
      <p>gender: male</p>
      <p>address: 33 naser city</p>
    </div>
    <div class="modal-footer">
      <button
        type="button"
        class="btn btn-secondary"
        data-dismiss="modal"
      >
        Close
      </button>
    </div>
  </div>
</div>
</div>
<!-- Add Patient Modal -->
<div class="modal fade" id="addPatientModal" tabindex="-1" role="dialog" aria-labelledby="addPatientModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-sm" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addPatientModalLabel">Add New Patient</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <form>
          <div class="form-group">
            <label for="PatientName">Patient full Name</label>
            <input type="text" class="form-control" id="PatientName">
          </div>
          <div class="form-group">
            <label for="userName">User Name</label>
            <input type="text" class="form-control" id="userName">
          </div>
          <div class="form-group">
            <label for="password">password</label>
            <input type="text" class="form-control" id="password">
          </div>
          <div class="form-group">
            <label for="Email">Email</label>
            <input type="text" class="form-control" id="Email">
          </div>
          <div class="form-group">
            <label for="Address">Address</label>
            <input type="text" class="form-control" id="Address">
          </div>
          <div class="form-group">
            <label for="Dateofbirth">Date of birth</label>
            <input type="text" class="form-control" id="Dateofbirth">
          </div>
          <div class="form-group">
            <label for="Gender">Gender</label>
            <select class="form-control" id="Gender">
              <option>Male</option>
              <option>Female</option>
            </select>
          </div>
          <div class="form-group">
            <label for="ContactNumber">Contact Number</label>
            <input type="text" class="form-control" id="ContactNumber">
          </div>
          
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" data-dismiss="modal">Save</button>
      </div>
    </div>
  </div>
</div>
<!-- Add Doctor Modal -->
<div class="modal fade" id="addDoctorModal" tabindex="-1" role="dialog" aria-labelledby="addDoctorModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-sm" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addDoctorModalLabel">Add New Doctor</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <form>
          <div class="form-group">
            <label for="doctorName">Doctor Name</label>
            <input type="text" class="form-control" id="doctorName">
          </div>
          <div class="form-group">
            <label for="userName">User Name</label>
            <input type="text" class="form-control" id="userName">
          </div>
          <div class="form-group">
            <label for="password">password</label>
            <input type="text" class="form-control" id="password">
          </div>
          <div class="form-group">
            <label for="Email">Email</label>
            <input type="text" class="form-control" id="Email">
          </div>
  <div class="form-group">
            <label for="Address">Address</label>
            <input type="text" class="form-control" id="Address">
          </div>
  <div class="form-group">
            <label for="Dateofbirth">Date of birth</label>
            <input type="text" class="form-control" id="Dateofbirth">
          </div>
  <div class="form-group">
            <label for="Gender">Gender</label>
            <select class="form-control" id="Gender">
              <option>Male</option>
              <option>Female</option>
            </select>
          </div>
<div class="form-group">
            <label for="ContactNumber">Contact Number</label>
            <input type="text" class="form-control" id="ContactNumber">
          </div>
          <div class="form-group">
            <label for="specialization">Specialization</label>
            <input type="text" class="form-control" id="specialization">
          </div>
          <div class="form-group">
            <label for="salary">salary</label>
            <input type="text" class="form-control" id="salary">
          </div>
          <div class="form-group">
            <label for="Shift">Shift</label>
            <select class="form-control" id="Shift">
              <option>9Am - 5PM</option>
              <option>5PM - 1Am</option>
              <option>1AM - 9Am</option>
            </select>
          </div>
          <div class="form-group">
            <label for="Department">Department</label>
            <input type="text" class="form-control" id="Department">
          </div>
          <div class="form-group">
            <label for="medicalLiencesNumber">medical Liences Number</label>
            <input type="text" class="form-control" id="medicalLiencesNumber">
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" data-dismiss="modal">Save</button>
      </div>
    </div>
  </div>
</div>
<!-- Add nurse Modal -->
<div class="modal fade" id="addNurseModal" tabindex="-1" role="dialog" aria-labelledby="addNurseModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-sm" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addNurseModalLabel">Add New Nurse</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <form>
          <div class="form-group">
            <label for="NurseName">Nurse Name</label>
            <input type="text" class="form-control" id="NurseName">
          </div>
          <div class="form-group">
            <label for="userName">User Name</label>
            <input type="text" class="form-control" id="userName">
          </div>
          <div class="form-group">
            <label for="password">password</label>
            <input type="text" class="form-control" id="password">
          </div>
          
          <div class="form-group">
            <label for="salary">salary</label>
            <input type="text" class="form-control" id="salary">
          </div>
          <div class="form-group">
            <label for="Shift">Shift</label>
            <select class="form-control" id="Shift">
              <option>9Am - 5PM</option>
              <option>5PM - 1Am</option>
              <option>1AM - 9Am</option>
            </select>
          </div>
          <div class="form-group">
            <label for="Department">Department</label>
            <input type="text" class="form-control" id="Department">
          </div>
          <div class="form-group">
            <label for="ward">Ward</label>
            <input type="text" class="form-control" id="ward">
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" data-dismiss="modal">Save</button>
      </div>
    </div>
  </div>
</div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.min.js"></script>
    <script>
      function toggleNav() {
        var sidebar = document.getElementById('mySidebar');
        var main = document.getElementById('main');
        if (sidebar.style.width === '250px' || sidebar.style.width === '100%') {
          sidebar.style.width = '0';
          main.style.marginLeft = '0';
        } else {
          sidebar.style.width = window.innerWidth <= 768 ? '100%' : '250px';
          main.style.marginLeft = window.innerWidth <= 768 ? '0' : '250px';
        }
      }

      function closeNav() {
        document.getElementById('mySidebar').style.width = '0';
        document.getElementById('main').style.marginLeft = '0';
      }

      $(document).ready(function () {
        $('.toggle-btn').click(function () {
          var content = $(this).next('.content');
          content.toggleClass('visible');
          $(this).text(
            content.hasClass('visible')
              ? $(this).text().replace('▽', '△')
              : $(this).text().replace('△', '▽')
          );
        });
      });
      function backdropFirstModal() {
    $('#addAppointmentModal').modal('toggle');
    setTimeout(function() {
      $('#addAppointmentModal').modal('show').addClass('backdroped-modal');
      //  $('#AddSystemUserModal').modal('show').addClass('backdroped-modal');
    }, 500);
  }

  $('#addDoctorModal').on('hidden.bs.modal', function () {
    $('#addAppointmentModal').removeClass('backdroped-modal');
    // $('#AddSystemUserModal').removeClass('backdroped-modal');
  });



  function setupTablePaginationAndSearch(tableSelector, paginationSelector) {
  document.addEventListener('DOMContentLoaded', function() {
    var rowsPerPage = 5;
    var table = document.querySelector(tableSelector);
    var rows = Array.from(table.querySelectorAll('tbody tr'));
    var searchFields = [];

    // Collect search fields dynamically based on the table headers
    table.querySelectorAll('thead th').forEach((th) => {
      searchFields.push(th.innerText.trim().toLowerCase());
    });

    // Create an array of row data for Fuse.js
    var rowData = rows.map(function(row) {
      return {
        element: row,
        ...Array.from(row.children).reduce((acc, cell, index) => {
          acc[searchFields[index]] = cell.innerText;
          return acc;
        }, {})
      };
    });

    // Fuse.js options
    var options = {
      includeScore: true,
      keys: searchFields,
      threshold: 0.3
    };

    var fuse = new Fuse(rowData, options);

    function showPage(page, filteredRows = rowData) {
      var start = (page - 1) * rowsPerPage;
      var end = start + rowsPerPage;

      // Hide all rows
      rows.forEach(row => row.style.display = 'none');

      // Show only the rows for the current page
      filteredRows.slice(start, end).forEach(row => row.element.style.display = '');
    }

    function searchTable(changedField) {
      var results = rowData;

      searchFields.forEach((field) => {
        var searchValue = document.getElementById(field + 'Search').value.trim().toLowerCase();
        if (searchValue) {
          results = fuse.search(searchValue).map(result => result.item);
        }
      });

      showPage(1, results);
      updatePagination(results);
    }

    function updatePagination(filteredRows = rowData) {
      var totalPages = Math.ceil(filteredRows.length / rowsPerPage);
      var pagination = document.querySelector(paginationSelector);
      pagination.innerHTML = '';

      for (var i = 1; i <= totalPages; i++) {
        var pageItem = document.createElement('li');
        pageItem.classList.add('page-item');
        pageItem.setAttribute('data-page', i);
        pageItem.innerHTML = `<a class="page-link" href="#">${i}</a>`;

        pageItem.addEventListener('click', function(e) {
          e.preventDefault();
          var page = parseInt(this.getAttribute('data-page'));
          showPage(page, filteredRows);

          Array.from(pagination.children).forEach(link => link.classList.remove('active'));
          this.classList.add('active');
        });

        pagination.appendChild(pageItem);
      }

      if (pagination.children.length > 0) {
        pagination.children[0].classList.add('active');
      }
    }

    function debounce(func, delay) {
      let timeout;
      return function() {
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(this, arguments), delay);
      };
    }

    const debouncedSearch = debounce(searchTable, 300);

    // Create search inputs dynamically
    searchFields.forEach((field) => {
      var searchInput = document.createElement('input');
      searchInput.type = 'text';
      searchInput.id = field + 'Search';
      searchInput.placeholder = `Search ${field.charAt(0).toUpperCase() + field.slice(1)}`;
      
      searchInput.addEventListener('input', function() {
        // Clear other search fields when one is typed into
        searchFields.forEach((f) => {
          if (f !== field) {
            document.getElementById(f + 'Search').value = '';
          }
        });

        debouncedSearch(field);
      });

      // Create a th for the search input
      var th = document.createElement('th');
      th.appendChild(searchInput);
      table.querySelector('thead tr:nth-child(2)').appendChild(th);
    });

    // Initialize pagination and show the first page
    showPage(1);
    updatePagination();
  });
}

// Usage: Call the function with your table selector and pagination selector
setupTablePaginationAndSearch('#appointmentTable', '#pagination');
setupTablePaginationAndSearch('#systemUsersTable', '#paginationUsers');

// sort filter
document.addEventListener('DOMContentLoaded', function() {
    const table = document.getElementById('appointmentTable');
    const headers = table.querySelectorAll('th:not(:last-child)'); // Exclude last column (Type)
    const rows = Array.from(table.querySelectorAll('tbody tr')); // Store all rows
    let currentSortColumn = null; // Track the current sorted column
    let currentSortDirection = 'none'; // Track sort direction

    // Function to sort the table
    function sortTable(columnIndex, direction) {
      const sortedRows = [...rows]; // Create a copy to avoid mutating the original rows array

      sortedRows.sort((a, b) => {
        
        const aText = a.children[columnIndex].innerText.toLowerCase();
        const bText = b.children[columnIndex].innerText.toLowerCase();
        // console.log(aText)

        if (direction === 'asc') {
          return aText.localeCompare(bText);
        } else if (direction === 'desc') {
          return bText.localeCompare(aText);
        }
        return 0; // No sorting
      });

      // Update the table body with sorted rows
      const tbody = table.querySelector('tbody');
      tbody.innerHTML = '';
      sortedRows.forEach(row => tbody.appendChild(row));
    }

    // Click event for sorting
    headers.forEach((header, index) => {
      // Create a span for the sorting indicator
      const indicatorSpan = document.createElement('span');
      indicatorSpan.style.marginLeft = '5px'; // Add some space between text and indicator
      header.appendChild(indicatorSpan);

      header.addEventListener('click', function() {
        // Determine new sort direction
        let newSortDirection;
        if (currentSortColumn === index) {
          if (currentSortDirection === 'asc') {
            newSortDirection = 'desc';
          } else if (currentSortDirection === 'desc') {
            newSortDirection = 'none';
          } else {
            newSortDirection = 'asc';
          }
        } else {
          newSortDirection = 'asc'; // Reset to ascending if a new column is clicked
        }

        // Clear previous indicators
        headers.forEach((h) => {
          const span = h.querySelector('span');
          if (span) {
            span.textContent = ''; // Remove previous indicators
          }
        });

        // Set the new indicator
        if (newSortDirection === 'asc') {
          indicatorSpan.textContent = '△'; // Ascending indicator
        } else if (newSortDirection === 'desc') {
          indicatorSpan.textContent = '▽'; // Descending indicator
        }

        // Sort the table based on the new direction
        sortTable(index, newSortDirection);

        // Update current sort column and direction
        currentSortColumn = index;
        currentSortDirection = newSortDirection;
      });
    });
  });

</script>
